<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Hours Alignment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 1600px;
            margin: auto;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-group {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .copy-buttons button{
            margin-right: 5px;
            width: 170px;
        }
        #timeBlocks {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* Two columns on larger screens */
    gap: 20px; /* Space between blocks */
}

@media (max-width: 768px) {
    #timeBlocks {
        grid-template-columns: 1fr; /* Stack items on smaller screens */
    }
}

.time-block {
    border: 1px solid #ccc;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 4px;
}
        .time-block {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .japan-time {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
 
        }
        .location-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .location-name {
            font-weight: 500;
        }
        .region-tag {
            font-size: 0.8em;
            color: #666;
            margin-left: 8px;
        }
        .dst {
            color: #e74c3c;
        }
        .dst-indicator {
    font-size: 0.8em;
    color: #e74c3c;
    margin-left: 8px;
    display: inline-block;
}
        #currentDate {
            text-align: center;
            font-size: 1.2em;
            margin: 20px 0;
            color: #333;
        }

        .location-type-tag {
            font-size: 0.7em;
            color: #666;
            margin-left: 5px;
            text-transform: uppercase;
        }
        .location-type-state { color: #3498db; }
        .location-type-province { color: #2ecc71; }
        .location-type-territory { color: #e74c3c; }
        .utc-offset-group {
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .utc-offset-title {
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
            margin-bottom: 8px;
            padding: 5px 10px;
            background: #e8f4f8;
            border-left: 4px solid #007bff;
            border-radius: 3px;
        }
        .monday-checkbox-container {
            display: flex;
            align-items: center;
            margin: 10px 0;

        }
        .monday-checkbox-container label {
            margin: 0 0 0 5px;
            font-weight: normal;
        }
        #svg-world-map-container { 
            width: 100%; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        @media (max-width: 1700px) {
            .container { max-width: 95%; }
        }
        @media (max-width: 768px) {
            #svg-world-map { height: 400px; }
        }
        
        /* Custom slider styling */
        #japanHourSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #japanHourSlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Global Time Zone Scheduler</h2>

    <div style="display: flex; gap: 20px; margin: 20px 0; justify-content: space-between;">
        <div style="flex: 1; min-width: 240px; max-width: 480px; background: #f5f5f5; padding: 15px; border-radius: 8px; overflow: hidden;">
            <label for="locationSearch"><b>Search Location:</b></label><br>
            <input type="text" id="locationSearch" placeholder="Enter country code, state code, or location name..." style="width: 100%; box-sizing: border-box; padding: 8px; margin: 10px 0 0 0; border: 1px solid #ddd; border-radius: 4px;">
            <div id="searchResults" style="margin-top: 10px; max-height: 400px; overflow-y: auto;"></div>
        </div>
        <div id="searchDetailsPanel" style="flex: 1; min-width: 240px; max-width: 480px; background: #f5f5f5; padding: 15px; border-radius: 8px; min-height: 120px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
        <div style="flex: 1; min-width: 240px; max-width: 480px; background: #f5f5f5; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; justify-content: flex-start;">
            <label for="japanHourSlider" style="display: flex; align-items: center;"><b>Focus on Specific Japan Hour:</b> <span id="japanHourLabel" style="margin-left: 8px;">07:00</span>
    <span id="japanHourInfoIcon" tabindex="0" style="margin-left: 8px; cursor: pointer; display: inline-block; position: relative;">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;"><circle cx="8" cy="8" r="8" fill="#007bff"/><text x="8" y="12" text-anchor="middle" font-size="10" fill="white" font-family="Arial" font-weight="bold">i</text></svg>
        <span id="japanHourTooltip" style="display:none; position:absolute; left:24px; top:-8px; background:#333; color:#fff; font-size:0.95em; padding:6px 12px; border-radius:5px; white-space:normal; z-index:10; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:220px; max-width:320px; line-height:1.4; word-break:normal;">Use this slider to see which countries have business hours active at a specific Japan time.</span>
    </span>
</label><br>
<div style="position: relative; margin: 20px 0;">
    <input type="range" id="japanHourSlider" min="0" max="23" value="7" style="width: 100%; margin: 0; -webkit-appearance: none; height: 6px; border-radius: 3px; background: #ddd; outline: none;">
    <div id="sliderLabels" style="position: relative; margin-top: 5px; font-size: 0.8em; color: #666; height: 15px;"></div>
</div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin: 20px 0;">
        <div style="flex: 2; min-width: 320px;">
            <div id="svg-world-map-container">
                <object id="svg-world-map" type="image/svg+xml" data="world-states-provinces.svg" width="100%" height="600"></object>
            </div>
        </div>
        <div style="flex: 1; min-width: 240px; max-width: 480px; height: 600px;">
            <div id="focusedTimeBlock" style="height: 100%; overflow-y: auto;"></div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <h3>Japan Business Hours</h3>
            <label for="startHourJP">Start Time:</label>
            <select id="startHourJP"></select>
            <label for="endHourJP">End Time:</label>
            <select id="endHourJP"></select>
            <div class="monday-checkbox-container">
                <input type="checkbox" id="mondayCheckbox">
                <label for="mondayCheckbox">Monday?</label>
            </div>
            <div class="monday-checkbox-container">
                <input type="checkbox" id="excludeCountriesCheckbox">
                <label for="excludeCountriesCheckbox">Exclude US/Canada/Australia</label>
            </div>
        </div>
        
        <div class="control-group">
            <h3>Local Business Hours</h3>
            <label for="startHourCall">Start Time:</label>
            <select id="startHourCall"></select>
            <label for="endHourCall">End Time:</label>
            <select id="endHourCall"></select>
        </div>
    </div>

    <h3 id="currentDate"></h3>
    <div id="timeBlocks"></div>
</div>

<script>
    let timezoneData = {};
    let pmAssignments = {};

    // Centralized exclusion list
    const EXCLUDED_COUNTRIES = ['United States', 'Canada', 'Australia'];

    async function loadTimezoneData() {
        try {
            const response = await fetch('combined_timezone_data.json');
            timezoneData = await response.json();
            
            // Load PM assignments
            const pmResponse = await fetch('pm_timezone_availability.json');
            const pmData = await pmResponse.json();
            
            // Convert PM data to lookup object
            pmData.forEach(item => {
                const offset = item['UTC Offset'];
                const assignment1 = item['PM Assignment #1'];
                const assignment2 = item['PM Assignment #2'];
                
                pmAssignments[offset] = {
                    primary: assignment1,
                    secondary: assignment2
                };
            });
            
            updateTimes();
            // Initialize map highlighting after data is loaded
            initializeMapHighlighting();
            // Render initial focused time block for 7am
            renderFocusedTimeBlock(7);
        } catch (error) {
            console.error('Error loading timezone data:', error);
        }
    }

    function initializeMapHighlighting() {
        const svgObject = document.getElementById('svg-world-map');
        const currentSliderHour = parseInt(document.getElementById('japanHourSlider').value);
        
        // Always wait for the SVG to be fully loaded before highlighting
        if (svgObject.contentDocument) {
            // Even if contentDocument exists, add a small delay to ensure full initialization
            setTimeout(() => {
                updateMapForSpecificHour(currentSliderHour);
            }, 100);
        } else {
            // Wait for SVG to load, then highlight
            svgObject.addEventListener('load', () => {
                // Add delay after load event to ensure SVG is fully ready
                setTimeout(() => {
                    updateMapForSpecificHour(currentSliderHour);
                }, 100);
            }, { once: true });
        }
    }

    function populateHourDropdowns() {
        const hours = [...Array(24).keys()];
        const selects = ['startHourJP', 'endHourJP', 'startHourCall', 'endHourCall'];
        
        selects.forEach(id => {
            const select = document.getElementById(id);
            select.innerHTML = '';
            hours.forEach(hour => {
                let option = document.createElement('option');
                option.value = hour;
                option.textContent = `${hour.toString().padStart(2, '0')}:00`;
                select.appendChild(option);
            });
        });

        document.getElementById('startHourJP').value = localStorage.getItem('startHourJP') || 9;
        document.getElementById('endHourJP').value = localStorage.getItem('endHourJP') || 17;
        document.getElementById('startHourCall').value = localStorage.getItem('startHourCall') || 9;
        document.getElementById('endHourCall').value = localStorage.getItem('endHourCall') || 17;
    }

    function saveHoursToLocalStorage() {
        localStorage.setItem('startHourJP', document.getElementById('startHourJP').value);
        localStorage.setItem('endHourJP', document.getElementById('endHourJP').value);
        localStorage.setItem('startHourCall', document.getElementById('startHourCall').value);
        localStorage.setItem('endHourCall', document.getElementById('endHourCall').value);
    }

    function isDST(timezone, currentDate) {
        const tzData = timezone.timezone_data;
        if (!tzData.has_dst) return false;
        const dstStart = new Date(tzData.dst_start);
        const dstEnd = new Date(tzData.dst_end);
        return currentDate >= dstStart && currentDate <= dstEnd;
    }

    function getOffsetSeconds(timezone, currentDate) {
        const tzData = timezone.timezone_data;
        return isDST(timezone, currentDate) ? tzData.dst_offset_seconds : tzData.standard_offset_seconds;
    }

    function highlightCountriesOnMap(countryCodes, stateProvinceCodes = {}) {
        // Wait for SVG to load
        const svgObject = document.getElementById('svg-world-map');
        if (!svgObject.contentDocument) {
            svgObject.addEventListener('load', () => highlightCountriesOnMap(countryCodes, stateProvinceCodes), { once: true });
            return;
        }
        const svgDoc = svgObject.contentDocument;
        
        // Hide Antarctica
        const antarctica = svgDoc.getElementById('AQ');
        if (antarctica) {
            antarctica.style.display = 'none';
        }
        
        // Hide ocean layer
        const ocean = svgDoc.getElementById('Ocean');
        if (ocean) {
            ocean.style.display = 'none';
        }
        
        // Reset all countries and states to default color first
        const allCountryGroups = svgDoc.querySelectorAll('g[id]');
        allCountryGroups.forEach(group => {
            if (group.id && group.id.length === 2 && group.id.match(/^[A-Z]{2}$/)) {
                // Set fill for all path elements within the country group
                const paths = group.querySelectorAll('path');
                paths.forEach(path => {
                    path.style.fill = '#e0e0e0';
                    path.style.stroke = '#888';
                    path.style.strokeWidth = '0.5';
                });
            }
        });
        
        // Also reset all state/province elements specifically (including nested ones)
        const stateElements = svgDoc.querySelectorAll('[id^="US-"], [id^="CA-"], [id^="AU-"]');
        stateElements.forEach(element => {
            element.style.fill = '#e0e0e0';
            element.style.stroke = '#888';
            element.style.strokeWidth = '0.5';
        });
        
        // For US, CA, AU - remove fills from country-level paths but keep state/province fills
        ['US', 'CA', 'AU'].forEach(countryCode => {
            const countryGroup = svgDoc.getElementById(countryCode);
            if (countryGroup) {
                // Remove fill from the group itself if it has one
                countryGroup.style.fill = 'none';
                
                const paths = countryGroup.querySelectorAll('path');
                paths.forEach(path => {
                    // Only remove fill if this is NOT a state/province element
                    if (!path.id || !path.id.match(/^(US|CA|AU)-[A-Z]{2,3}(-|$)/)) {
                        path.style.fill = 'none';
                        path.style.stroke = '#888';
                        path.style.strokeWidth = '0.5';
                    }
                });
            }
        });

        // Highlight selected countries (non-US/CA/AU)
        countryCodes.forEach(code => {
            const countryCode = code.toUpperCase();
            
            // Skip US, CA, AU - they'll be handled by state/province highlighting
            if (countryCode === 'US' || countryCode === 'CA' || countryCode === 'AU') {
                return;
            }
            
            const countryGroup = svgDoc.getElementById(countryCode);
            if (countryGroup) {
                // Highlight all path elements within the country group
                const paths = countryGroup.querySelectorAll('path');
                paths.forEach(path => {
                    path.style.fill = '#87CEEB';
                    path.style.stroke = '#888';
                    path.style.strokeWidth = '0.5';
                });
            }
        });
        
        // Highlight specific states/provinces for US, CA, AU
        Object.keys(stateProvinceCodes).forEach(country => {
            const codes = stateProvinceCodes[country];
            codes.forEach(code => {
                let elementId;
                if (country === 'US') {
                    elementId = `US-${code}`;
                } else if (country === 'CA') {
                    elementId = `CA-${code}`;
                } else if (country === 'AU') {
                    elementId = `AU-${code}`;
                }
                
                if (elementId) {
                    const stateElement = svgDoc.getElementById(elementId);
                    if (stateElement) {
                        const fillColor = '#87CEEB';
                        
                        stateElement.style.fill = fillColor;
                        stateElement.style.stroke = '#888';
                        stateElement.style.strokeWidth = '0.5';
                        
                        // Also fill any nested elements that start with the same ID
                        const nestedElements = svgDoc.querySelectorAll(`[id^="${elementId}-"]`);
                        nestedElements.forEach(nestedElement => {
                            nestedElement.style.fill = fillColor;
                            nestedElement.style.stroke = '#888';
                            nestedElement.style.strokeWidth = '0.5';
                        });
                        
                        console.log(`Successfully highlighted ${country} state: ${elementId} (and ${nestedElements.length} nested elements)`);
                    } else {
                        console.log(`Element not found for ${country} state: ${elementId}`);
                    }
                }
            });
        });
    }

    function updateMapForSpecificHour(japanHour) {
        const currentDate = new Date();
        const japanOffsetSeconds = 32400;
        const startHourCall = parseInt(document.getElementById('startHourCall').value);
        const endHourCall = parseInt(document.getElementById('endHourCall').value);
        const highlightedCountries = new Set();
        const stateProvinceCodes = { US: [], CA: [], AU: [] };

        Object.entries(timezoneData).forEach(([tz, data]) => {
            data.locations.forEach(location => {
                const offsetSeconds = getOffsetSeconds(data, currentDate);
                const localOffsetHours = (offsetSeconds - japanOffsetSeconds) / 3600;
                const localHour = (japanHour + localOffsetHours + 24) % 24;

                // Add condition to exclude US and Canada if Monday checkbox is checked
                const isMondayChecked = document.getElementById('mondayCheckbox').checked;
                if (isMondayChecked && 
                    (location.country === 'United States' || location.country === 'Canada')) {
                    return; // Skip these locations
                }

                if (localHour >= startHourCall && localHour < endHourCall) {
                    // Exclude countries if checkbox is checked
                    const excludeCountriesChecked = document.getElementById('excludeCountriesCheckbox').checked;
                    if (!excludeCountriesChecked || !EXCLUDED_COUNTRIES.includes(location.country)) {
                        
                        // Handle US, Canada, Australia with state/province highlighting
                        if (location.country_code === 'US' && location.state_code) {
                            stateProvinceCodes.US.push(location.state_code);
                        } else if (location.country_code === 'CA' && location.province_code) {
                            stateProvinceCodes.CA.push(location.province_code);
                        } else if (location.country_code === 'AU' && location.state_code) {
                            stateProvinceCodes.AU.push(location.state_code);
                        } else {
                            // For all other countries, highlight the whole country
                            highlightedCountries.add(location.country_code);
                        }
                    }
                }
            });
        });

        // Remove duplicates from state/province arrays
        stateProvinceCodes.US = [...new Set(stateProvinceCodes.US)];
        stateProvinceCodes.CA = [...new Set(stateProvinceCodes.CA)];
        stateProvinceCodes.AU = [...new Set(stateProvinceCodes.AU)];

        // Debug: Log what we found
        console.log('State/Province codes collected:', stateProvinceCodes);

        highlightCountriesOnMap(Array.from(highlightedCountries), stateProvinceCodes);
    }

    function getPMAssignmentText(utcOffset) {
        const assignment = pmAssignments[utcOffset];
        if (!assignment) return '';
        
        let text = ` - ${assignment.primary}`;
        if (assignment.secondary) {
            text += ` | ${assignment.secondary}`;
        }
        return text;
    }

    function createTimeBlock(japanHour, currentDate, showCopyButtons = true) {
        const timeBlock = document.createElement('div');
        timeBlock.className = 'time-block';

        const japanTime = document.createElement('div');
        japanTime.className = 'japan-time';

        const japanTimeText = document.createElement('span');
        japanTimeText.textContent = `${japanHour.toString().padStart(2, '0')}:00 JST`;

        if (showCopyButtons) {
            const copyButtons = document.createElement('div');
            copyButtons.className = 'copy-buttons';

            const copyStateProvinceBtn = document.createElement('button');
            copyStateProvinceBtn.className = 'copy-btn copy-state-province';
            copyStateProvinceBtn.textContent = 'Copy State/Province';

            const copyCountryBtn = document.createElement('button');
            copyCountryBtn.className = 'copy-btn copy-country';
            copyCountryBtn.textContent = 'Copy Country';

            copyButtons.appendChild(copyStateProvinceBtn);
            copyButtons.appendChild(copyCountryBtn);
            japanTime.appendChild(copyButtons);

            // Add copy event listener for State/Province button
            copyStateProvinceBtn.addEventListener('click', () => {
                const combinedList = [...stateProvinceCodes, ...stateProvinceNames].join(';');
                navigator.clipboard.writeText(combinedList).then(() => {
                    copyStateProvinceBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyStateProvinceBtn.textContent = 'Copy State/Province';
                    }, 2000);
                });
            });

            copyCountryBtn.addEventListener('click', () => {
                const countryCodes = [];
                const countryNames = [];

                Object.entries(timezoneData).forEach(([tz, data]) => {
                    data.locations.forEach(location => {
                        const offsetSeconds = getOffsetSeconds(data, currentDate);
                        const localOffsetHours = (offsetSeconds - japanOffsetSeconds) / 3600;
                        const localHour = (japanHour + localOffsetHours + 24) % 24;
            
                        if (localHour >= startHourCall && localHour < endHourCall) {
                            // Exclude countries if checkbox is checked
                            const excludeCountriesChecked = document.getElementById('excludeCountriesCheckbox').checked;
                            if (!excludeCountriesChecked || !EXCLUDED_COUNTRIES.includes(location.country)) {
                                // Avoid duplicates
                                if (!countryCodes.includes(location.country_code)) {
                                    countryCodes.push(location.country_code);
                                    countryNames.push(location.country);
                                }
                            }
                        }
                    });
                });

                const combinedList = [...countryCodes, ...countryNames].join(';');
                navigator.clipboard.writeText(combinedList).then(() => {
                    copyCountryBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyCountryBtn.textContent = 'Copy Country';
                    }, 2000);
                });
            });
        }

        japanTime.appendChild(japanTimeText);

        const locationList = document.createElement('div');
        locationList.className = 'location-list';

        const japanOffsetSeconds = 32400;
        const startHourCall = parseInt(document.getElementById('startHourCall').value);
        const endHourCall = parseInt(document.getElementById('endHourCall').value);

        // Collect all locations with their calculated times
        let locationsWithTimes = [];
        let stateProvinceCodes = [];
        let stateProvinceNames = [];

        Object.entries(timezoneData).forEach(([tz, data]) => {
            data.locations.forEach(location => {
                const offsetSeconds = getOffsetSeconds(data, currentDate);
                const localOffsetHours = (offsetSeconds - japanOffsetSeconds) / 3600;
                const localHour = (japanHour + localOffsetHours + 24) % 24;

                // Add condition to exclude US and Canada if Monday checkbox is checked
                const isMondayChecked = document.getElementById('mondayCheckbox').checked;
                if (isMondayChecked && 
                    (location.country === 'United States' || location.country === 'Canada')) {
                    return; // Skip these locations
                }

                if (localHour >= startHourCall && localHour < endHourCall) {
                    locationsWithTimes.push({
                        location: location,
                        localHour: localHour,
                        data: data,
                        isDST: isDST(data, currentDate)
                    });

                    // Collect state/province codes and names
                    if (location.location_type === 'state' && location.state_code) {
                        stateProvinceCodes.push(location.state_code);
                        stateProvinceNames.push(location.state);
                    } else if (location.location_type === 'province' && location.province_code) {
                        stateProvinceCodes.push(location.province_code);
                        stateProvinceNames.push(location.province);
                    }
                }
            });
        });

        // Sort by local hour first, then alphabetically by location name
        locationsWithTimes.sort((a, b) => {
            if (a.localHour !== b.localHour) {
                return a.localHour - b.localHour;
            }
            
            // Get the location name, with fallback
            const getLocationName = (location) => {
                return location.state || location.province || location.country || 'Unknown';
            };
            
            return getLocationName(a.location).localeCompare(getLocationName(b.location));
        });

        // Group locations by UTC offset
        const offsetGroups = {};
        locationsWithTimes.forEach(item => {
            const offsetSeconds = getOffsetSeconds(item.data, currentDate);
            const utcOffset = offsetSeconds / 3600;
            const offsetLabel = `UTC${utcOffset >= 0 ? '+' : ''}${utcOffset}`;
            
            if (!offsetGroups[offsetLabel]) {
                offsetGroups[offsetLabel] = [];
            }
            offsetGroups[offsetLabel].push(item);
        });

        // Sort offset groups by numeric UTC offset
        const sortedOffsetKeys = Object.keys(offsetGroups).sort((a, b) => {
            const aNum = parseFloat(a.replace('UTC', ''));
            const bNum = parseFloat(b.replace('UTC', ''));
            
            // Positive offsets first (ascending), then negative offsets (descending)
            if (aNum >= 0 && bNum >= 0) {
                return aNum - bNum; // Both positive: ascending order
            } else if (aNum < 0 && bNum < 0) {
                return aNum - bNum; // Both negative: descending order by absolute value (-11, -10, -9)
            } else {
                return bNum - aNum; // Mixed: positive comes first
            }
        });

        // Create DOM elements for each UTC offset group
        sortedOffsetKeys.forEach(offsetLabel => {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'utc-offset-group';
            
            const groupTitle = document.createElement('div');
            groupTitle.className = 'utc-offset-title';
            
            // Extract numeric offset and add PM assignment
            const numericOffset = parseFloat(offsetLabel.replace('UTC', ''));
            const pmText = getPMAssignmentText(numericOffset);
            groupTitle.textContent = offsetLabel + pmText;
            
            groupContainer.appendChild(groupTitle);
            
            offsetGroups[offsetLabel].forEach(item => {
                // Determine the specific location name based on location type
                const specificLocationName = 
                    item.location.state || 
                    item.location.province ||
                    item.location.country;
                
                // Ensure we always have a name to display
                if (!specificLocationName) {
                    console.warn('Location without a name:', item.location);
                    return;
                }

                const locationItem = document.createElement('div');
                locationItem.className = 'location-item';

                const locationName = document.createElement('div');
                locationName.className = 'location-name';
                
                // Display location name with country
                locationName.innerHTML = `${specificLocationName} ${item.location.country && specificLocationName !== item.location.country ? `(${item.location.country})` : ''}`;
                
                // Add location type tag
                if (item.location.location_type && item.location.location_type !== 'country') {
                    const typeTag = document.createElement('span');
                    typeTag.className = `location-type-tag location-type-${item.location.location_type}`;
                    typeTag.textContent = item.location.location_type;
                    locationName.appendChild(typeTag);
                }
                
                // Add DST indicator if applicable
                if (item.isDST) {
                    const dstIndicator = document.createElement('span');
                    dstIndicator.className = 'dst-indicator';
                    dstIndicator.textContent = `DST Active (${item.data.timezone_data.dst_name})`;
                    locationName.appendChild(dstIndicator);
                }

                const localTime = document.createElement('div');
                localTime.className = 'local-time';
                localTime.textContent = `${Math.floor(item.localHour).toString().padStart(2, '0')}:00`;

                locationItem.appendChild(locationName);
                locationItem.appendChild(localTime);
                groupContainer.appendChild(locationItem);
            });
            
            locationList.appendChild(groupContainer);
        });

        timeBlock.appendChild(japanTime);
        timeBlock.appendChild(locationList);
        return timeBlock;
    }

    function updateTimes() {
        saveHoursToLocalStorage();

        const container = document.getElementById('timeBlocks');
        container.innerHTML = '';

        const currentDate = new Date();
        const startHourJP = parseInt(document.getElementById('startHourJP').value);
        const endHourJP = parseInt(document.getElementById('endHourJP').value);

        // Collect all country codes that should be highlighted across all time blocks
        const allHighlightedCountries = new Set();
        const japanOffsetSeconds = 32400;
        const startHourCall = parseInt(document.getElementById('startHourCall').value);
        const endHourCall = parseInt(document.getElementById('endHourCall').value);

        for (let hour = startHourJP; hour < endHourJP; hour++) {
            container.appendChild(createTimeBlock(hour, currentDate, true));
            
            // Collect countries for this hour for map highlighting
            Object.entries(timezoneData).forEach(([tz, data]) => {
                data.locations.forEach(location => {
                    const offsetSeconds = getOffsetSeconds(data, currentDate);
                    const localOffsetHours = (offsetSeconds - japanOffsetSeconds) / 3600;
                    const localHour = (hour + localOffsetHours + 24) % 24;

                    // Add condition to exclude US and Canada if Monday checkbox is checked
                    const isMondayChecked = document.getElementById('mondayCheckbox').checked;
                    if (isMondayChecked && 
                        (location.country === 'United States' || location.country === 'Canada')) {
                        return; // Skip these locations
                    }

                    if (localHour >= startHourCall && localHour < endHourCall) {
                        // Exclude countries if checkbox is checked
                        const excludeCountriesChecked = document.getElementById('excludeCountriesCheckbox').checked;
                        if (!excludeCountriesChecked || !EXCLUDED_COUNTRIES.includes(location.country)) {
                            allHighlightedCountries.add(location.country_code);
                        }
                    }
                });
            });
        }

        // Note: Map highlighting is now controlled by the slider, not by the time blocks
        // The time blocks show all countries, but the map shows only the slider-selected hour

        document.getElementById('currentDate').textContent =
            `Current Date: ${currentDate.toLocaleDateString('en-US', {
                timeZone: 'Asia/Tokyo',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}`;
    }

    function searchLocations(query) {
        const results = [];
        const currentDate = new Date();
        
        if (!query || query.length < 1) {
            return results;
        }
        
        query = query.toLowerCase();
        
        Object.entries(timezoneData).forEach(([tz, data]) => {
            data.locations.forEach(location => {
                const matches = [];
                
                // For countries with states/provinces (US, CA, AU), only show state/province level
                // For other countries, show country level
                const hasSubdivisions = location.state || location.province;
                const isCountryWithSubdivisions = ['US', 'CA', 'AU'].includes(location.country_code);
                
                // Skip country-level entries for countries that have subdivisions
                if (isCountryWithSubdivisions && !hasSubdivisions) {
                    return;
                }
                
                // Check country code
                if (location.country_code && location.country_code.toLowerCase().includes(query)) {
                    matches.push(`Country Code: ${location.country_code}`);
                }
                
                // Check state code
                if (location.state_code && location.state_code.toLowerCase().includes(query)) {
                    matches.push(`State Code: ${location.state_code}`);
                }
                
                // Check province code
                if (location.province_code && location.province_code.toLowerCase().includes(query)) {
                    matches.push(`Province Code: ${location.province_code}`);
                }
                
                // Check country name (only for countries without subdivisions)
                if (location.country && location.country.toLowerCase().includes(query) && !isCountryWithSubdivisions) {
                    matches.push(`Country: ${location.country}`);
                }
                
                // Check state name
                if (location.state && location.state.toLowerCase().includes(query)) {
                    matches.push(`State: ${location.state}`);
                }
                
                // Check province name
                if (location.province && location.province.toLowerCase().includes(query)) {
                    matches.push(`Province: ${location.province}`);
                }
                
                if (matches.length > 0) {
                    const offsetSeconds = getOffsetSeconds(data, currentDate);
                    const utcOffset = offsetSeconds / 3600;
                    const offsetLabel = `UTC${utcOffset >= 0 ? '+' : ''}${utcOffset}`;
                    const pmText = getPMAssignmentText(utcOffset);
                    
                    results.push({
                        location: location,
                        matches: matches,
                        utcOffset: offsetLabel,
                        pmAssignment: pmText || ' - No PM Assignment',
                        isDST: isDST(data, currentDate),
                        dstName: data.timezone_data.dst_name,
                        data: data // Pass the timezone data for offset calculation
                    });
                }
            });
        });
        
        // Remove duplicates based on location
        const uniqueResults = [];
        const seen = new Set();
        
        results.forEach(result => {
            const key = `${result.location.country_code}-${result.location.state_code || ''}-${result.location.province_code || ''}`;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueResults.push(result);
            }
        });
        
        return uniqueResults.slice(0, 10); // Limit to 10 results
    }

    let searchResultsCache = [];
    let searchSelectedIndex = -1;

    function displaySearchResults(results) {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';
        searchResultsCache = results;
        searchSelectedIndex = -1;
        
        if (!results || results.length === 0) {
            // Remove the default instructional message from the search results panel
            // Only update the details panel
            const detailsPanel = document.getElementById('searchDetailsPanel');
            if (detailsPanel) {
                detailsPanel.innerHTML = '';
                const defaultDetailsMsg = document.createElement('div');
                defaultDetailsMsg.style.cssText = 'color: #666; font-size: 1em; padding: 12px; text-align: center;';
                defaultDetailsMsg.textContent = 'Search for a location to see details here.';
                detailsPanel.appendChild(defaultDetailsMsg);
            }
            return;
        }
        
        results.forEach((result, idx) => {
            const resultItem = document.createElement('div');
            resultItem.style.cssText = `
                padding: 8px;
                margin: 5px 0;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                border-left: 4px solid #007bff;
                cursor: pointer;
            `;
            resultItem.tabIndex = 0;
            resultItem.dataset.idx = idx;
            
            // Create a more readable location description
            let locationDescription = '';
            if (result.location.state) {
                locationDescription = `(${result.location.country_code}-${result.location.state_code}) ${result.location.country}, ${result.location.state}`;
            } else if (result.location.province) {
                locationDescription = `(${result.location.country_code}-${result.location.province_code}) ${result.location.country}, ${result.location.province}`;
            } else {
                locationDescription = `(${result.location.country_code}) ${result.location.country}`;
            }
            
            // Add additional codes if they match the search (state/province codes)
            const additionalCodes = [];
            if (result.matches.some(m => m.includes('State Code:'))) {
                additionalCodes.push(`State Code: ${result.location.state_code}`);
            }
            if (result.matches.some(m => m.includes('Province Code:'))) {
                additionalCodes.push(`Province Code: ${result.location.province_code}`);
            }
            
            if (additionalCodes.length > 0) {
                locationDescription += ` - ${additionalCodes.join(', ')}`;
            }
            
            const locationInfo = document.createElement('div');
            locationInfo.style.fontWeight = 'bold';
            locationInfo.textContent = locationDescription;
            
            const offsetInfo = document.createElement('div');
            offsetInfo.style.cssText = 'font-size: 0.9em; color: #333; margin-top: 2px;';
            offsetInfo.textContent = `${result.utcOffset}${result.pmAssignment}`;
            
            if (result.isDST) {
                const dstInfo = document.createElement('div');
                dstInfo.style.cssText = 'font-size: 0.8em; color: #e74c3c; margin-top: 2px;';
                dstInfo.textContent = `DST Active (${result.dstName})`;
                resultItem.appendChild(dstInfo);
            }
            
            resultItem.appendChild(locationInfo);
            resultItem.appendChild(offsetInfo);
            
            // Add click handler to show details in the right panel and clear results
            resultItem.addEventListener('click', function() {
                showSearchDetails(result);
                setSearchSelected(idx);
                document.getElementById('searchResults').innerHTML = '';
            });
            
            container.appendChild(resultItem);
        });
    }

    function setSearchSelected(idx) {
        const container = document.getElementById('searchResults');
        const items = Array.from(container.children);
        items.forEach((item, i) => {
            if (i === idx) {
                item.style.background = '#e8f4f8';
                item.style.outline = '2px solid #007bff';
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.style.background = 'white';
                item.style.outline = 'none';
            }
        });
        searchSelectedIndex = idx;
    }

    function showSearchDetails(result) {
        const panel = document.getElementById('searchDetailsPanel');
        panel.innerHTML = '';
        
        // Location title
        let locationDescription = '';
        if (result.location.state) {
            locationDescription = `(${result.location.country_code}-${result.location.state_code}) ${result.location.country}, ${result.location.state}`;
        } else if (result.location.province) {
            locationDescription = `(${result.location.country_code}-${result.location.province_code}) ${result.location.country}, ${result.location.province}`;
        } else {
            locationDescription = `(${result.location.country_code}) ${result.location.country}`;
        }
        const title = document.createElement('div');
        title.style.fontWeight = 'bold';
        title.style.fontSize = '1em';
        title.style.marginBottom = '4px';
        title.textContent = locationDescription;
        panel.appendChild(title);
        
        // Offset and PM assignment
        const offsetInfo = document.createElement('div');
        offsetInfo.style.cssText = 'font-size: 0.9em; color: #333; margin-bottom: 4px;';
        offsetInfo.textContent = `${result.utcOffset}${result.pmAssignment}`;
        panel.appendChild(offsetInfo);
        
        // DST info
        if (result.isDST) {
            const dstInfo = document.createElement('div');
            dstInfo.style.cssText = 'font-size: 0.9em; color: #e74c3c; margin-bottom: 4px;';
            dstInfo.textContent = `DST Active (${result.dstName})`;
            panel.appendChild(dstInfo);
        }
        
        // Calculate Japan time ranges for calling
        const japanOffsetSeconds = 32400; // JST is UTC+9
        const currentDate = new Date();
        const offsetSeconds = getOffsetSeconds(result.data || {}, currentDate);
        const localToJapanOffset = (japanOffsetSeconds - offsetSeconds) / 3600;
        
        // Get local business hours from dropdowns
        const startHourCall = parseInt(document.getElementById('startHourCall').value);
        const endHourCall = parseInt(document.getElementById('endHourCall').value);
        
        // Calculate Japan time range(s)
        let japanStart = (startHourCall + localToJapanOffset + 24) % 24;
        let japanEnd = (endHourCall + localToJapanOffset + 24) % 24;
        
        // Format as 00:00
        function formatHour(h) {
            return h.toString().padStart(2, '0') + ':00';
        }
        
        let timeRangeText = '';
        if (japanStart < japanEnd) {
            timeRangeText = `${formatHour(Math.floor(japanStart))} - ${formatHour(Math.floor(japanEnd))} JST`;
        } else if (japanStart > japanEnd) {
            // Overnight range
            timeRangeText = `${formatHour(Math.floor(japanStart))} - 23:59 JST and 00:00 - ${formatHour(Math.floor(japanEnd))} JST`;
        } else {
            timeRangeText = 'No available time range (start and end are the same)';
        }
        
        const timeRangeDiv = document.createElement('div');
        timeRangeDiv.style.cssText = 'font-size: 0.9em; color: #007bff; margin-top: 0; margin-bottom: 4px;';
        timeRangeDiv.textContent = `Japan time to call: ${timeRangeText}`;
        panel.appendChild(timeRangeDiv);

        // --- Add hour-by-hour list ---
        // Build a list of all Japan hours in the call window, with corresponding local times
        let hourPairs = [];
        if (japanStart < japanEnd) {
            for (let h = Math.floor(japanStart); h < Math.floor(japanEnd); h++) {
                let japanHour = (h + 24) % 24;
                let localHour = (japanHour - localToJapanOffset + 24) % 24;
                hourPairs.push({ japan: japanHour, local: localHour });
            }
        } else if (japanStart > japanEnd) {
            // Overnight: from japanStart to 23, then 0 to japanEnd-1
            for (let h = Math.floor(japanStart); h < 24; h++) {
                let japanHour = (h + 24) % 24;
                let localHour = (japanHour - localToJapanOffset + 24) % 24;
                hourPairs.push({ japan: japanHour, local: localHour });
            }
            for (let h = 0; h < Math.floor(japanEnd); h++) {
                let japanHour = (h + 24) % 24;
                let localHour = (japanHour - localToJapanOffset + 24) % 24;
                hourPairs.push({ japan: japanHour, local: localHour });
            }
        }
        // Only show the list if there are hours
        if (hourPairs.length > 0) {
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; margin-top: 12px; border-collapse: collapse; font-size: 0.9em;';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th style="text-align:left; padding: 4px 8px;">Japan Time</th><th style="text-align:left; padding: 4px 8px;">Local Time</th>';
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            hourPairs.forEach(pair => {
                const row = document.createElement('tr');
                row.innerHTML = `<td style="padding: 4px 8px;">${formatHour(pair.japan)}</td><td style="padding: 4px 8px;">${formatHour(pair.local)}</td>`;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            panel.appendChild(table);
        }
    }

    // Generate slider time labels
    function generateSliderLabels() {
        const labelsContainer = document.getElementById('sliderLabels');
        labelsContainer.innerHTML = '';
        
        // Show labels every 3 hours: 00, 03, 06, 09, 12, 15, 18, 21
        for (let hour = 0; hour <= 21; hour += 3) {
            const label = document.createElement('span');
            label.textContent = hour.toString().padStart(2, '0') + ':00';
            label.style.position = 'absolute';
            label.style.fontSize = '0.75em';
            label.style.color = '#666';
            label.style.transform = 'translateX(-50%)';
            
            // Calculate the position as a percentage (hour/23 * 100%)
            const position = (hour / 23) * 100;
            label.style.left = position + '%';
            
            labelsContainer.appendChild(label);
        }
    }

    // Initialize slider functionality and checkbox listeners
    document.addEventListener('DOMContentLoaded', function() {
        const slider = document.getElementById('japanHourSlider');
        const label = document.getElementById('japanHourLabel');
        const searchInput = document.getElementById('locationSearch');
        
        // Generate time labels for slider
        generateSliderLabels();
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            const query = searchInput.value.trim();
            const results = searchLocations(query);
            displaySearchResults(results);
        });
        
        // Keyboard navigation for search results
        searchInput.addEventListener('keydown', function(e) {
            if (!searchResultsCache.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (searchSelectedIndex < searchResultsCache.length - 1) {
                    setSearchSelected(searchSelectedIndex + 1);
                } else {
                    setSearchSelected(0);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (searchSelectedIndex > 0) {
                    setSearchSelected(searchSelectedIndex - 1);
                } else {
                    setSearchSelected(searchResultsCache.length - 1);
                }
            } else if (e.key === 'Enter') {
                if (searchSelectedIndex >= 0 && searchSelectedIndex < searchResultsCache.length) {
                    showSearchDetails(searchResultsCache[searchSelectedIndex]);
                    document.getElementById('searchResults').innerHTML = '';
                }
            }
        });
        
        slider.addEventListener('input', function() {
            const currentHour = parseInt(slider.value, 10);
            label.textContent = currentHour.toString().padStart(2, '0') + ':00';
            updateMapForSpecificHour(currentHour);
            renderFocusedTimeBlock(currentHour);
        });
        
        // Set initial label
        label.textContent = slider.value.toString().padStart(2, '0') + ':00';
        // Render initial focused time block
        renderFocusedTimeBlock(parseInt(slider.value, 10));
        
        // Add listeners for checkboxes to update display when changed
        document.getElementById('mondayCheckbox').addEventListener('change', function() {
            updateTimes();
            const currentHour = parseInt(slider.value, 10);
            updateMapForSpecificHour(currentHour);
            renderFocusedTimeBlock(currentHour);
        });
        
        document.getElementById('excludeCountriesCheckbox').addEventListener('change', function() {
            updateTimes();
            const currentHour = parseInt(slider.value, 10);
            updateMapForSpecificHour(currentHour);
            renderFocusedTimeBlock(currentHour);
        });

        // Add change listeners to the dropdowns to auto-refresh times
        ['startHourJP', 'endHourJP', 'startHourCall', 'endHourCall'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', function() {
                    updateTimes();
                });
            }
        });

        // Show default search message on load
        displaySearchResults([]);
        // Show default details message on load
        const detailsPanel = document.getElementById('searchDetailsPanel');
        if (detailsPanel) {
            detailsPanel.innerHTML = '';
            const defaultDetailsMsg = document.createElement('div');
            defaultDetailsMsg.style.cssText = 'color: #666; font-size: 1em; padding: 12px; text-align: center;';
            defaultDetailsMsg.textContent = 'Search for a location to see details here.';
            detailsPanel.appendChild(defaultDetailsMsg);
        }

        // Tooltip for Japan hour info icon
        var infoIcon = document.getElementById('japanHourInfoIcon');
        var tooltip = document.getElementById('japanHourTooltip');
        if (infoIcon && tooltip) {
            function showTooltip() {
                tooltip.style.display = 'block';
                tooltip.style.left = '24px'; // Always reset before measuring
                // Check if tooltip overflows right edge
                var rect = tooltip.getBoundingClientRect();
                var rightOverflow = rect.right - window.innerWidth;
                if (rightOverflow > 0) {
                    tooltip.style.left = (24 - rightOverflow - 8) + 'px'; // shift left
                }
            }
            function hideTooltip() {
                tooltip.style.display = 'none';
                tooltip.style.left = '24px';
            }
            infoIcon.addEventListener('mouseenter', showTooltip);
            infoIcon.addEventListener('mouseleave', hideTooltip);
            infoIcon.addEventListener('focus', showTooltip);
            infoIcon.addEventListener('blur', hideTooltip);
        }
    });

    populateHourDropdowns();
    loadTimezoneData();

    // Add a function to render the focused time block for the selected Japan hour
    function renderFocusedTimeBlock(japanHour) {
        const container = document.getElementById('focusedTimeBlock');
        container.innerHTML = '';
        const currentDate = new Date();
        const block = createTimeBlock(japanHour, currentDate, false);
        // Remove margin-top from the time-block
        if (block && block.style) block.style.marginTop = '0';
        container.appendChild(block);
    }
</script>

</body>
</html>
